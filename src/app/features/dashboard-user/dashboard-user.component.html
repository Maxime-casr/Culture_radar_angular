<div class="page">
  <!-- HERO / intro -->
  <header class="page-hero">
    <h1>Mon agenda</h1>
    <p class="subtitle">
      Retrouvez vos participations, naviguez par mois et g√©rez vos sorties.
      Cliquez sur une date pour voir les √©v√©nements du jour‚Äâ; vous pouvez
      <strong>annuler</strong> une sortie future ou <strong>noter</strong> un √©v√©nement pass√©.
    </p>
    <div class="quick-actions">
      <a [routerLink]="['/event-list']" class="btn btn-primary">Explorer des √©v√©nements</a>
      <a [routerLink]="['/']" class="btn btn-ghost">Retour √† l‚Äôaccueil</a>
    </div>
  </header>

  <!-- Grille 2 colonnes -->
  <div class="page-grid">
    <!-- Colonne gauche : calendrier -->
    <section class="agenda card">
      <header class="cal-header">
        <button class="nav" (click)="prevMonth()" aria-label="Mois pr√©c√©dent">‚óÄ</button>
        <h2 class="cal-title">{{ monthLabel | titlecase }}</h2>
        <button class="nav" (click)="nextMonth()" aria-label="Mois suivant">‚ñ∂</button>
      </header>

      <!-- Jours de semaine -->
      <div class="cal-weekdays" aria-hidden="true">
        <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
      </div>

      <!-- Grille 6x7 -->
      <div class="cal-grid" *ngIf="!loading; else loadingTpl">
        <button
          *ngFor="let d of days"
          class="day"
          [class.other]="!d.isCurrentMonth"
          [class.past]="d.isPast"
          [class.today]="d.isToday"
          [class.selected]="d.ymd === selectedYmd"
          (click)="selectDay(d)"
          [attr.aria-label]="(d.date | date:'EEEE d MMMM yyyy')"
        >
          <span class="num">{{ d.date.getDate() }}</span>
          <span class="dot" *ngIf="d.events.length"></span>
        </button>
      </div>

      <ng-template #loadingTpl>
        <div class="loading">Chargement de vos participations‚Ä¶</div>
      </ng-template>

      <!-- L√©gende -->
      <footer class="legend">
        <span class="legend-item"><span class="legend-dot"></span> √âv√©nement(s)</span>
        <span class="legend-item"><span class="legend-key today"></span> Aujourd‚Äôhui</span>
        <span class="legend-item"><span class="legend-key selected"></span> S√©lectionn√©</span>
      </footer>

      <p class="hint">Astuce : utilisez les fl√®ches ‚óÄ / ‚ñ∂ pour changer de mois.</p>
    </section>

    <!-- Colonne droite : d√©tails du jour -->
    <section class="day-details card">
      <h3 *ngIf="selectedYmd as ymd" class="day-title">
        {{ (ymd + 'T00:00:00') | date:'EEEE d MMMM yyyy' | titlecase }}
      </h3>

      <div *ngIf="selectedEvents.length === 0" class="empty">
        <div class="empty-illu">üéüÔ∏è</div>
        <p>Aucun √©v√®nement ce jour.</p>
        <a [routerLink]="['/event-list']" class="btn btn-link">Voir les √©v√©nements √† venir</a>
      </div>

      <div class="event-list" *ngIf="selectedEvents.length">
        <div class="event-card" *ngFor="let p of selectedEvents">
          <div class="info">
            <h4>{{ p.evenement_titre }}</h4>
            <p class="meta">
              {{ p.occurrence_debut | date:'HH:mm' }}
              <span *ngIf="p.occurrence_fin"> ‚Üí {{ p.occurrence_fin | date:'HH:mm' }}</span>
              <span *ngIf="p.evenement_lieu"> ‚Ä¢ {{ p.evenement_lieu }}</span>
            </p>
            <div class="tags">
              <span class="tag" *ngIf="p.evenement_type">{{ p.evenement_type }}</span>
              <span class="tag city" *ngIf="p.evenement_commune">{{ p.evenement_commune }}</span>
            </div>
          </div>

          <div class="actions">
            <a [routerLink]="['/event', p.evenement_id]" class="btn details">D√©tails</a>
            <button *ngIf="isFuture(p)" class="btn danger" (click)="cancel(p)">Annuler</button>
            <button *ngIf="!isFuture(p)" class="btn" (click)="openRating(p)">Noter</button>
          </div>
        </div>
      </div>

      <aside class="helper">
        <h4>Bon √† savoir</h4>
        <ul>
          <li>Vous pouvez annuler tant que l‚Äô√©v√©nement n‚Äôa pas commenc√©.</li>
          <li>La notation devient disponible apr√®s l‚Äô√©v√©nement.</li>
          <li>Besoin d‚Äôid√©es&nbsp;? Parcourez la liste compl√®te des √©v√©nements.</li>
        </ul>
      </aside>
    </section>
  </div>
</div>

<!-- Modale de note (inchang√©) -->
<div class="rating-overlay" *ngIf="ratingOpen" (click)="closeRating()"></div>
<div class="rating-panel" *ngIf="ratingOpen" role="dialog" aria-modal="true">
  <header class="rating-header">
    <h4>Donner une note</h4>
    <button class="icon-btn" (click)="closeRating()" aria-label="Fermer">‚úï</button>
  </header>

  <div class="rating-body" *ngIf="ratingTarget as rt">
    <p class="event-title">{{ rt.evenement_titre }}</p>

    <div class="avg" *ngIf="ratingAvg !== null">
      Moyenne : {{ ratingAvg | number:'1.1-2' }} / 5
      <span *ngIf="ratingCount !== null">‚Äì {{ ratingCount }} vote{{ ratingCount === 1 ? '' : 's' }}</span>
    </div>
    <div class="avg" *ngIf="ratingAvg === null && ratingLoading">Chargement‚Ä¶</div>

    <div class="picker" [class.disabled]="ratingSaving">
      <button *ngFor="let n of [1,2,3,4,5]" type="button" class="pick" [class.active]="ratingValue === n" (click)="ratingValue = n">
        {{ n }}
      </button>
    </div>

    <div class="actions">
      <button class="btn details" [disabled]="!ratingValue || ratingSaving" (click)="submitRating()">
        {{ ratingSaving ? 'Enregistrement‚Ä¶' : 'Valider' }}
      </button>
    </div>
  </div>
</div>

